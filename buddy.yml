- pipeline: "setup"
  trigger_mode: "MANUAL"
  ref_name: "refs/heads/*"
  ref_type: "WILDCARD"
  fetch_all_refs: true
  trigger_condition: "ALWAYS"
  actions:
  - action: "Run setup playbook"
    type: "BUILD"
    working_directory: "/buddy/repman"
    docker_image_name: "library/ubuntu"
    docker_image_tag: "19.10"
    execute_commands:
    - "ansible-playbook ansible/setup.yml -i ansible/inventories/$REPMAN_ANSIBLE_INVENTORY"
    setup_commands:
    - "apt-get update && apt-get -y install ansible ssh python3-distutils"
    - "mkdir ~/.ssh && ssh-keyscan 3.136.55.89 >> ~/.ssh/known_hosts"
    volume_mappings:
    - "/:/buddy/repman"
    trigger_condition: "ALWAYS"
    shell: "BASH"
- pipeline: "deploy"
  trigger_mode: "MANUAL"
  ref_name: "master"
  ref_type: "BRANCH"
  target_site_url: "https://app.repman.io"
  fetch_all_refs: true
  trigger_condition: "ALWAYS"
  actions:
  - action: "Run deploy playbook"
    type: "BUILD"
    working_directory: "/buddy/repman"
    docker_image_name: "library/ubuntu"
    docker_image_tag: "19.10"
    execute_commands:
    - "ansible-playbook ansible/deploy.yml -i ansible/inventories/$REPMAN_ANSIBLE_INVENTORY"
    setup_commands:
    - "apt-get update && apt-get -y install ansible ssh python3-distutils"
    - "mkdir ~/.ssh && ssh-keyscan 3.136.55.89 >> ~/.ssh/known_hosts"
    volume_mappings:
    - "/:/buddy/repman"
    trigger_condition: "ALWAYS"
    shell: "BASH"
- pipeline: "[master] Build and push Docker image"
  trigger_mode: "ON_EVERY_PUSH"
  ref_name: "master"
  ref_type: "BRANCH"
  fetch_all_refs: true
  trigger_condition: "ALWAYS"
  actions:
  - action: "Run repman/test"
    type: "RUN_NEXT_PIPELINE"
    wait: true
    comment: "Triggered by $BUDDY_PIPELINE_NAME execution #$BUDDY_EXECUTION_ID"
    trigger_condition: "ALWAYS"
    revision: "INHERIT"
    next_project_name: "repman"
    next_pipeline_name: "test"
  - action: "Lint Dockerfile"
    type: "DOCKERFILE_LINTER"
    local_path: "Dockerfile"
    shell_type: "bash"
    trigger_condition: "ALWAYS"
    ignore_errors: true
  - action: "Build Docker image"
    type: "DOCKERFILE"
    dockerfile_path: "Dockerfile"
    trigger_condition: "ALWAYS"
  - action: "Push Docker image"
    type: "DOCKER_PUSH"
    login: "$REPMAN_DOCKER_HUB_LOGIN"
    password: "$REPMAN_DOCKER_HUB_PASSWORD"
    docker_image_tag: "latest"
    repository: "buddy/repman"
    trigger_condition: "ALWAYS"
- pipeline: "[tag] Build and push Docker image"
  trigger_mode: "ON_EVERY_PUSH"
  ref_name: "refs/tags/*"
  ref_type: "WILDCARD"
  fetch_all_refs: true
  trigger_condition: "ALWAYS"
  actions:
  - action: "Run repman/test"
    type: "RUN_NEXT_PIPELINE"
    wait: true
    comment: "Triggered by $BUDDY_PIPELINE_NAME execution #$BUDDY_EXECUTION_ID"
    trigger_condition: "ALWAYS"
    revision: "INHERIT"
    next_project_name: "repman"
    next_pipeline_name: "test"
  - action: "Lint Dockerfile"
    type: "DOCKERFILE_LINTER"
    local_path: "Dockerfile"
    shell_type: "bash"
    trigger_condition: "ALWAYS"
    ignore_errors: true
  - action: "Build Docker image"
    type: "DOCKERFILE"
    dockerfile_path: "Dockerfile"
    trigger_condition: "ALWAYS"
  - action: "Push Docker image"
    type: "DOCKER_PUSH"
    login: "$REPMAN_DOCKER_HUB_LOGIN"
    password: "$REPMAN_DOCKER_HUB_PASSWORD"
    docker_image_tag: "$BUDDY_EXECUTION_TAG"
    repository: "buddy/repman"
    trigger_condition: "ALWAYS"

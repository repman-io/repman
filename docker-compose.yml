version: '3.4'

x-restart-policy: &restart_policy
  restart: unless-stopped

services:
  database:
    << : *restart_policy
    image: postgres:11.20-alpine
    logging:
      driver: none
    environment:
      POSTGRES_USER: main
      POSTGRES_PASSWORD: main
      POSTGRES_DB: main
    volumes:
      - postgres-data:/var/lib/postgresql/data

  app:
    << : *restart_policy
    build:
        context: .
        dockerfile: .docker/development/Dockerfile
    sysctls:
      net.core.somaxconn: 2048
    env_file: .env.docker
    volumes:
      - app-var:/app/var
      - /app/var/cache
      - app-public:/app/public
    depends_on:
      - database
      - redis
    expose:
      - "80"

  consumer:
    << : *restart_policy
    image: buddy/repman:1.3.4
    command: ['bin/console', 'messenger:consume', 'async', '--limit=500']
    env_file: .env.docker
    volumes:
      - app-var:/app/var
      - /app/var/cache
    depends_on:
      - app

  redis:
    <<: *restart_policy
    image: redis:6.2-alpine
    expose:
      - "6379"

volumes:
  postgres-data:
  app-var:
    driver: local
    driver_opts:
      type: none
      device: $PWD/var
      o: bind
  app-public:
    driver: local
    driver_opts:
      type: none
      device: $PWD/public
      o: bind
